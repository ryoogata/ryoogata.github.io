<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: Kvm | YggdrasillNetwork Blog]]></title>
  <link href="http://ryoogata.github.io/blog/tags/kvm/atom.xml" rel="self"/>
  <link href="http://ryoogata.github.io/"/>
  <updated>2015-02-20T00:05:19+09:00</updated>
  <id>http://ryoogata.github.io/</id>
  <author>
    <name><![CDATA[Ryo Ogata]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Wakame-vdc のカスタムイメージ作成手順]]></title>
    <link href="http://ryoogata.github.io/2015/02/06/wakame-vdc-kvm/"/>
    <updated>2015-02-06T23:02:07+09:00</updated>
    <id>http://ryoogata.github.io/2015/02/06/wakame-vdc-kvm</id>
    <content type="html"><![CDATA[<h1>概要</h1>

<p>Wakame-vdc ( KVM 環境 ) で利用可能なカスタムイメージを作成する</p>

<h1>CentOS 6.6 の場合</h1>

<h2>仮想HDDイメージファイルの作成</h2>

<pre><code># dd if=/dev/zero of=/var/lib/libvirt/images/centos66.img bs=1M count=10240
</code></pre>

<h2>インストール開始</h2>

<p>VNC経由もしくはテキストモードにてインストールを実施する</p>

<h3>VNC 経由の場合</h3>

<p>VNC 経由で作業を実施するために、<code>virt-viewr</code> を事前にインストールしておく</p>

<pre><code># yum install virt-viewer
</code></pre>

<p>下記のコマンドを実行し、インストールを実施</p>

<pre><code># virt-install \
 --virt-type=kvm \
 --hvm \
 --connect qemu:///system \
 --vcpus 1 \
 --ram=1024 \
 --os-type=linux \
 --os-variant=rhel6 \
 --network bridge=br0 \
 --vnc --vncport=29741 --vnclisten=0.0.0.0 \
 --name centos66 \
 --disk=/var/lib/libvirt/images/centos66.img \
 --location='/var/lib/libvirt/images/CentOS-6.6-x86_64-bin-DVD1.iso' \
 --accelerate
</code></pre>

<h3>テキストモードの場合</h3>

<p>テキストモードインストールでは、GUIインストールとは異なり、パーティション等の編集メニューが出てこない。
インストール時に指定したい場合には、キックスタートを利用してインストールすればよい。</p>

<pre><code># virt-install \
 --virt-type=kvm \
 --hvm \
 --connect qemu:///system \
 --vcpus 1 \
 --ram=1024 \
 --os-type=linux \
 --os-variant=rhel6 \
 --network bridge=br0 \
 --nographics \
 --extra-args='console=tty0 console=ttyS0, 115200n8' \
 --name centos66 \
 --disk=/var/lib/libvirt/images/centos.img \
 --location='/var/lib/libvirt/images/CentOS-6.6-x86_64-bin-DVD1.iso' \
 --accelerate \
</code></pre>

<h2>ドメインの起動</h2>

<pre><code># virsh start centos66
</code></pre>

<h2>OS のカスタマイズ</h2>

<h3>selinux の disable</h3>

<p>selinux は disable にしておく</p>

<h3>不要ファイル削除</h3>

<pre><code>rm -rf /root/.bash_history
rm -rf /etc/ssh/ssh_host*
rm -rf /etc/udev/rules.d/70-persistent-net.rules
</code></pre>

<h3>root パーティションの UUID を調べておく</h3>

<pre><code>[root@localhost ssh]# blkid
/dev/vda1: UUID="60dbb3b6-a9d8-4550-82f1-e9acdf40b3f8" TYPE="ext4"
/dev/vda2: UUID="6204d842-2c5d-498a-93a5-ff8bd105a1db" TYPE="swap"
</code></pre>

<h3>カスタマイズ後</h3>

<p>必要なカスタマイズが完了したのち、OS を shutdown する</p>

<h2>OS イメージの圧縮と移動</h2>

<p>OS イメージ圧縮前のファイルサイズを控えておく</p>

<pre><code># ls -al centos66.img
</code></pre>

<p>/var/lib/libvirt/images</p>

<p>圧縮の実行</p>

<pre><code># gzip -c centos66.img &gt; /var/lib/wakame-vdc/images/20150203_1_centos66.img.gz
</code></pre>

<p>OS イメージ圧縮後のファイルサイズを控えておく</p>

<pre><code># ls -al 20150203_1_centos66.img.gz
</code></pre>

<h2>OS イメージの md5 の取得</h2>

<p>OS イメージの md5 checksum 値を控えておく</p>

<pre><code># md5sum 20150203_2_centos66.img.gz
</code></pre>

<h2>Wakame-vdc にカスタムイメージを登録</h2>

<p>vdc-manage コマンドを実行</p>

<pre><code># /opt/axsh/wakame-vdc/dcmgr/bin/vdc-manage
</code></pre>

<p>事前に控えていた下記の情報を基にカスタムイメージを DB に登録</p>

<ul>
<li>圧縮前 OS イメージファイルサイズ</li>
<li>圧縮後 OS イメージファイルサイズ</li>
<li>OS イメージの md5 checksum</li>
<li>root パーティションの UUID</li>
</ul>


<pre><code>backupobject add \
 --uuid 20150203_3_centos66 \
 --display-name "CentOS 6.6" \
 --storage-id bkst-local \
 --object-key 20150203_3_centos66.img.gz \
 --size              323502676 \
 --allocation-size 10737418240 \
 --container-format gz \
 --checksum 3e28c4d4eef476319d63c936b3403c04

image add local bo-20150203_3_centos66 \
 --account-id a-shpoolxx \
 --uuid wmi-20150203_3_centos66 \
 --root-device uuid:60dbb3b6-a9d8-4550-82f1-e9acdf40b3f8 \
 --display-name "CentOS 6.6"
</code></pre>

<h1>ubuntu-14.04 の場合</h1>

<p>作業途中で失敗する</p>

<h2>仮想HDDイメージファイルの作成</h2>

<pre><code># dd if=/dev/zero of=/var/lib/libvirt/images/ubuntu.img bs=1M count=10240
</code></pre>

<h2>ISO イメージをループバックマウント</h2>

<pre><code># mount --read-only --options loop ubuntu-14.04.1-server-amd64.iso ISO
</code></pre>

<h2>インストール開始</h2>

<h3>VNC 経由の場合</h3>

<pre><code># virt-install \
 --name=TestMachine \
 --ram=2048 \
 --vcpus=1 \
 --os-variant ubuntuprecise \
 --hvm \
 --connect qemu:///system \
 --virt-type=kvm \
 --disk=/var/lib/libvirt/images/ubuntu.img,format=qcow2 \
 --network=bridge:br0 \
 --keymap=ja \
 --location /var/lib/libvirt/images/ISO/ \
 --serial pty \
 --extra-args=console=ttyS0
</code></pre>

<h1>Tips</h1>

<h2>SSH PortFoward</h2>

<pre><code># ssh -L 29741:localhost:29741 root@172.16.1.108 
</code></pre>

<h2>gzip 圧縮 ( 元ファイル残す )</h2>

<pre><code># gzip -c centos66.img &gt; 20150202_2_centos66.img.gz
</code></pre>

<h1>参照 URL</h1>

<ul>
<li><a href="http://www.maruko2.com/mw/CentOS/%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE_UUID_%E3%82%92%E7%A2%BA%E8%AA%8D%E3%83%BB%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">CentOS/パーティションの UUID を確認・変更する方法</a></li>
<li><a href="http://blog.osamu.habuka.jp/blog/2014/12/03/try-to-make-wakame-vdcs-image/">Wakame-VDC のマシンイメージを作ってみる</a></li>
<li><a href="http://www.oss-d.net/virt/kvm/backup">KVMにおけるゲストOSのバックアップ/リストア </a></li>
<li><a href="https://github.com/axsh/wakame-vdc/wiki/Custom-images">Custom images</a></li>
<li><a href="http://blog.livedoor.jp/hide_system/archives/51888446.html">CentOS6.4(minimal) KVMによる仮想環境構築(テキストモード)</a></li>
<li><a href="http://fishrimper.blogspot.jp/2014/01/kvm-os-ubuntu.html">KVM ゲスト OS としてコンソールから Ubuntu をインストール </a></li>
</ul>

]]></content>
  </entry>
  
</feed>
