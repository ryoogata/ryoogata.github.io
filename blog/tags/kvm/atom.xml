<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: Kvm | YggdrasillNetwork Blog]]></title>
  <link href="http://ryoogata.github.io/blog/tags/kvm/atom.xml" rel="self"/>
  <link href="http://ryoogata.github.io/"/>
  <updated>2015-02-20T12:25:24+09:00</updated>
  <id>http://ryoogata.github.io/</id>
  <author>
    <name><![CDATA[Ryo Ogata]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Wakame 用 カスタム KVM イメージ作成]]></title>
    <link href="http://ryoogata.github.io/2015/02/19/wakame-vdc/"/>
    <updated>2015-02-19T23:49:08+09:00</updated>
    <id>http://ryoogata.github.io/2015/02/19/wakame-vdc</id>
    <content type="html"><![CDATA[<h1>作成手順</h1>

<h2>yum update の実行</h2>

<pre><code># yum update -y
</code></pre>

<h2>selinux 設定</h2>

<p>selinux Permissive</p>

<h2>必要なパッケージのインストール</h2>

<pre><code>yum install -y telnet tcpdump wget man man-pages ntpdate bind-utils openssh-clients
</code></pre>

<h2>ipv6 disable 設定</h2>

<pre><code># chkconfig ip6tables off
</code></pre>

<p>/etc/sysconfig/network に NETWORKING_IPV6=no を追加</p>

<pre><code># echo 'options ipv6 disable=1' &gt; /etc/modprobe.d/disable-ipv6.conf
</code></pre>

<h2>ssh 設定</h2>

<p>/etc/ssh/sshd_config
Port 2442</p>

<h2>wakame-init の Download</h2>

<pre><code># cd /etc
# wget https://raw.githubusercontent.com/axsh/wakame-vdc/master/wakame-init/rhel/6/wakame-init
</code></pre>

<h2>rc.local の編集</h2>

<p>/etc/rc.local に設定追加</p>

<h2>root-device の UUID の確認</h2>

<pre><code># blkid
   :
/dev/vda3: UUID="893013b4-bf1e-47b6-baf3-495193b76238" TYPE="ext4" 
</code></pre>

<h2>不要ファイル削除</h2>

<pre><code>rm -rf /root/.bash_history
rm -rf /etc/ssh/ssh_host*
rm -rf /etc/udev/rules.d/70-persistent-net.rules
</code></pre>

<h2>OS イメージの圧縮と移動</h2>

<p>OS イメージ圧縮前のファイルサイズを控えておく</p>

<pre><code># ls -al centos66.img
</code></pre>

<p>/var/lib/libvirt/images</p>

<p>圧縮の実行</p>

<pre><code># gzip -c centos66.img &gt; /var/lib/wakame-vdc/images/20150203_1_centos66.img.gz
</code></pre>

<p>OS イメージ圧縮後のファイルサイズを控えておく</p>

<pre><code># ls -al 20150203_1_centos66.img.gz
</code></pre>

<h2>OS イメージの md5 の取得</h2>

<p>OS イメージの md5 checksum 値を控えておく</p>

<pre><code># md5sum 20150203_2_centos66.img.gz
</code></pre>

<h2>vdc へイメージの登録</h2>

<p>vdc-manage コマンドを実行</p>

<pre><code># /opt/axsh/wakame-vdc/dcmgr/bin/vdc-manage
</code></pre>

<p>事前に控えていた下記の情報を基にカスタムイメージを DB に登録</p>

<ul>
<li>圧縮前 OS イメージファイルサイズ</li>
<li>圧縮後 OS イメージファイルサイズ</li>
<li>OS イメージの md5 checksum</li>
<li>root パーティションの UUID</li>
</ul>


<pre><code>backupobject add \
 --uuid 20150213_1_cent_base \
 --display-name "CentOS 6.6" \
 --storage-id bkst-local \
 --object-key 20150213_1_cent_base.img.gz \
 --size              492162200 \
 --allocation-size 17179869184 \
 --container-format gz \
 --checksum 9f4089bd93fcb48a90a0a22b0d0be04d

image add local bo-20150213_1_cent_base \
 --account-id a-shpoolxx \
 --uuid wmi-20150213_1_cent_base \
 --root-device uuid:893013b4-bf1e-47b6-baf3-495193b76238 \
 --display-name "CentOS 6.6"
</code></pre>

<h1>参照 URL</h1>

<ul>
<li><a href="https://github.com/axsh/wakame-vdc/wiki/Custom-images">Custom images</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[KVM Tips]]></title>
    <link href="http://ryoogata.github.io/2015/02/19/kvm/"/>
    <updated>2015-02-19T23:23:43+09:00</updated>
    <id>http://ryoogata.github.io/2015/02/19/kvm</id>
    <content type="html"><![CDATA[<h1>概要</h1>

<p>KVM 操作の際の Tips</p>

<h1>virsh コマンド</h1>

<h2>ドメイン一覧表示 ( 停止中を含む )</h2>

<pre><code># virsh list --all
</code></pre>

<h2>ドメインの起動</h2>

<pre><code># virsh start centos66
</code></pre>

<h2>ドメインの強制停止</h2>

<pre><code># virsh destroy pc2
</code></pre>

<h2>ドメインの削除</h2>

<pre><code># virsh undefine centos66
</code></pre>

<p>※ 停止中のドメインのみ実行可能</p>

<h2>ゲストのコンソールに接続</h2>

<pre><code># virsh console 5
</code></pre>

<h2>ゲストのコンソールから抜ける</h2>

<pre><code>^] 
</code></pre>

<h2>VM の設定ファイルを編集</h2>

<pre><code># virsh edit &lt;vm-name&gt;
</code></pre>

<h1>NIC の追加</h1>

<p>VM が起動している状態で実行可能</p>

<pre><code># virsh attach-interface --type bridge --source br0 --model e1000 nat
</code></pre>

<h1>VM に Disk の追加</h1>

<p>VM が Down している状態で実行する</p>

<h2>1. Disk Image の作成</h2>

<pre><code># cd /var/lib/libvirt/images
# qemu-img create -f qcow2 disk_Maria-1.img 40G
</code></pre>

<h2>2. 設定の追加</h2>

<p>virsh edit コマンドを利用して設定を追記</p>

<pre><code># virsh edit Maria-1
</code></pre>

<ul>
<li>追加分 Config</li>
</ul>


<pre><code>&lt;disk type='file' device='disk'&gt;
  &lt;driver name='qemu' type='qcow2' cache='none'/&gt;
  &lt;source file='/var/lib/libvirt/images/disk_Maria-1.img'/&gt;
  &lt;target dev='vdb' bus='virtio'/&gt;
&lt;/disk&gt;
</code></pre>

<h1>VM のクローン</h1>

<h2>1. クローンコマンドの実行</h2>

<p>VM が Down している状態で実行</p>

<pre><code># virt-clone --original cent_base --name Maria-1 --file /var/lib/libvirt/images/Maria-1.img
</code></pre>

<h2>2. MAC Address のメモ</h2>

<pre><code># virsh dumpxml Maria-1 | grep mac
    &lt;type arch='x86_64' machine='rhel6.6.0'&gt;hvm&lt;/type&gt;
      &lt;mac address='52:54:00:64:df:4f'/&gt;
</code></pre>

<h2>3. vnc port の編集</h2>

<p>既存の VM とかぶらない VNC の Port 番号に変更</p>

<pre><code># virsh edit Maria-1
</code></pre>

<h2>4. VM の起動</h2>

<pre><code>virsh start Maria-1
</code></pre>

<h2>5. 70-persistent-net.rules の編集</h2>

<p>ここから VNC 経由で接続して作業</p>

<pre><code>/etc/udev/rules.d/70-persistent-net.rules
</code></pre>

<h2>6. ifcfg-eth0 の編集</h2>

<p>UUID
BOOTPROTO=dchp</p>

<p>BOOTPROTO=none
IPADDR=211.14.1.11
NETMASK=255.255.255.192</p>

<h2>7. VM の再起動</h2>

<h2>8. Interface のアドレス設定</h2>

<p>手動で IP アドレスを付与</p>

<h2>9. resolv.conf の編集</h2>

<h1>参照 URL</h1>

<ul>
<li><a href="http://www.agilegroup.co.jp/technote/kvm-guest-clone.html">KVMのクローンを利用して新規仮想マシンを作成する</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[KVM VM に OS をインストール]]></title>
    <link href="http://ryoogata.github.io/2015/02/06/wakame-vdc-kvm/"/>
    <updated>2015-02-06T23:02:07+09:00</updated>
    <id>http://ryoogata.github.io/2015/02/06/wakame-vdc-kvm</id>
    <content type="html"><![CDATA[<h1>概要</h1>

<p>KVM VM に OS をインストールする手法のまとめ</p>

<h1>CentOS 6.6 の場合</h1>

<h2>仮想HDDイメージファイルの作成</h2>

<pre><code># dd if=/dev/zero of=/var/lib/libvirt/images/centos66.img bs=1M count=10240
</code></pre>

<h2>インストール開始</h2>

<p>VNC経由もしくはテキストモードにてインストールを実施する</p>

<h3>VNC 経由の場合</h3>

<p>VNC 経由で作業を実施するために、<code>virt-viewr</code> を事前にインストールしておく</p>

<pre><code># yum install virt-viewer
</code></pre>

<p>下記のコマンドを実行し、インストールを実施</p>

<pre><code># virt-install \
 --virt-type=kvm \
 --hvm \
 --connect qemu:///system \
 --vcpus 1 \
 --ram=1024 \
 --os-type=linux \
 --os-variant=rhel6 \
 --network bridge=br0 \
 --vnc --vncport=29741 --vnclisten=0.0.0.0 \
 --name centos66 \
 --disk=/var/lib/libvirt/images/centos66.img \
 --location='/var/lib/libvirt/images/CentOS-6.6-x86_64-bin-DVD1.iso' \
 --accelerate
</code></pre>

<h3>テキストモードの場合</h3>

<p>テキストモードインストールでは、GUIインストールとは異なり、パーティション等の編集メニューが出てこない。
インストール時に指定したい場合には、キックスタートを利用してインストールすればよい。</p>

<pre><code># virt-install \
 --virt-type=kvm \
 --hvm \
 --connect qemu:///system \
 --vcpus 1 \
 --ram=1024 \
 --os-type=linux \
 --os-variant=rhel6 \
 --network bridge=br0 \
 --nographics \
 --extra-args='console=tty0 console=ttyS0, 115200n8' \
 --name centos66 \
 --disk=/var/lib/libvirt/images/centos.img \
 --location='/var/lib/libvirt/images/CentOS-6.6-x86_64-bin-DVD1.iso' \
 --accelerate \
</code></pre>

<h2>ドメインの起動</h2>

<pre><code># virsh start centos66
</code></pre>

<h1>ubuntu-14.04 の場合</h1>

<p>作業途中で失敗する&hellip;</p>

<h2>仮想HDDイメージファイルの作成</h2>

<pre><code># dd if=/dev/zero of=/var/lib/libvirt/images/ubuntu.img bs=1M count=10240
</code></pre>

<h2>ISO イメージをループバックマウント</h2>

<pre><code># mount --read-only --options loop ubuntu-14.04.1-server-amd64.iso ISO
</code></pre>

<h2>インストール開始</h2>

<h3>VNC 経由の場合</h3>

<pre><code># virt-install \
 --name=TestMachine \
 --ram=2048 \
 --vcpus=1 \
 --os-variant ubuntuprecise \
 --hvm \
 --connect qemu:///system \
 --virt-type=kvm \
 --disk=/var/lib/libvirt/images/ubuntu.img,format=qcow2 \
 --network=bridge:br0 \
 --keymap=ja \
 --location /var/lib/libvirt/images/ISO/ \
 --serial pty \
 --extra-args=console=ttyS0
</code></pre>

<h1>Tips</h1>

<h2>SSH PortFoward</h2>

<pre><code># ssh -L 29741:localhost:29741 root@172.16.1.108 
</code></pre>

<h2>gzip 圧縮 ( 元ファイル残す )</h2>

<pre><code># gzip -c centos66.img &gt; 20150202_2_centos66.img.gz
</code></pre>

<h1>参照 URL</h1>

<ul>
<li><a href="http://www.maruko2.com/mw/CentOS/%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE_UUID_%E3%82%92%E7%A2%BA%E8%AA%8D%E3%83%BB%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">CentOS/パーティションの UUID を確認・変更する方法</a></li>
<li><a href="http://blog.osamu.habuka.jp/blog/2014/12/03/try-to-make-wakame-vdcs-image/">Wakame-VDC のマシンイメージを作ってみる</a></li>
<li><a href="http://www.oss-d.net/virt/kvm/backup">KVMにおけるゲストOSのバックアップ/リストア </a></li>
<li><a href="https://github.com/axsh/wakame-vdc/wiki/Custom-images">Custom images</a></li>
<li><a href="http://blog.livedoor.jp/hide_system/archives/51888446.html">CentOS6.4(minimal) KVMによる仮想環境構築(テキストモード)</a></li>
<li><a href="http://fishrimper.blogspot.jp/2014/01/kvm-os-ubuntu.html">KVM ゲスト OS としてコンソールから Ubuntu をインストール </a></li>
</ul>

]]></content>
  </entry>
  
</feed>
